#!/usr/bin/env python3
import argparse
import getpass
import json
import os
import shutil
import signal
import subprocess
import sys
import tempfile
import glob
import re

import gi

gi.require_version("Gtk", "3.0")
from gi.repository import GdkPixbuf, GLib, Gtk

try:
    subprocess.run(
        ["dbus-launch"],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        check=True,
    )
except subprocess.CalledProcessError:
    pass

RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
BLUE = "\033[94m"
MAGENTA = "\033[95m"
CYAN = "\033[96m"
RESET = "\033[0m"

# --- P≈ôevzato z spacefin-cli ---
DEFAULT_REPO_URL = "https://github.com/ExistingPerson08/Spacefin-cli.git"
REPO_FOLDER_NAME = "spacefin-assets"
# ---------------------------------


class Colors:
# ... (k√≥d pro Colors z≈Øst√°v√° stejn√Ω) ...
# ... (existing code) ...
    def __init__(self):
        self.use_color = "NO_COLOR" not in os.environ
        if self.use_color:
# ... (existing code) ...
            self.c4 = "\u001b[38;5;98m"
        else:
            self.NC = self.BGreen = self.BCyan = self.BYellow = ""
# ... (existing code) ...
            self.c1 = self.c2 = self.c3 = self.c4 = ""


colors = Colors()


# Handler for ctrl+c
def signal_handler(sig, frame):
# ... (existing code) ...
    sys.exit(0)


signal.signal(signal.SIGINT, signal_handler)


def setup_argparse():
# ... (existing code) ...
    )
    parser.add_argument("--version", action="store_true", help="Show version")
    return parser


def clone_repo(repo_url, temp_dir):
    """Clone repository (p≈ôevzato z spacefin-cli)"""
    clone_path = os.path.join(temp_dir, REPO_FOLDER_NAME)

    try:
        subprocess.run(
            ["git", "clone", "--depth", "1", repo_url, clone_path],
            check=True,
            capture_output=True,
            text=True,
            encoding="utf-8",
        )
        return clone_path
    except FileNotFoundError:
        print(f"‚ùå ERROR: 'git' command not found. Please make sure git is installed.")
        # TODO: Zobrazit GTK dialog
        raise
    except subprocess.CalledProcessError as e:
        print(f"‚ùå ERROR: Failed to clone repository.")
        if e.stderr:
            print(f"   Details: {e.stderr.strip()}")
        raise
    except Exception as e:
        print(f"‚ùå ERROR: An unexpected error occurred during cloning: {e}")
        raise


def load_install_items(clone_path):
    """Naƒçte polo≈æky pro 'install' (Tweaks) z JSON soubor≈Ø."""
    items = []
    install_dir = os.path.join(clone_path, "install")
    if not os.path.isdir(install_dir):
        print(f"Warning: 'install' directory not found in repo.")
        return items

    for json_file in glob.glob(os.path.join(install_dir, "*.json")):
        bundle_name = os.path.splitext(os.path.basename(json_file))[0]
        try:
            with open(json_file, "r", encoding="utf-8") as f:
                data = json.load(f)
            # Naƒçte 'name' z JSON, pokud neexistuje, pou≈æije jm√©no souboru
            display_name = data.get("name", bundle_name)
            # Naƒçte 'icon' z JSON, pokud neexistuje, pou≈æije v√Ωchoz√≠
            icon = data.get("icon", "application-x-executable")
            items.append(
                {
                    "label": display_name,
                    "icon": icon,
                    "command": ["spacefin-cli", "install", bundle_name],
                }
            )
        except Exception as e:
            print(f"Error parsing {json_file}: {e}")
    return items


def load_run_items(clone_path):
    """Naƒçte polo≈æky pro 'run' (Repairs) z .sh skript≈Ø."""
    items = []
    run_dir = os.path.join(clone_path, "run")
    if not os.path.isdir(run_dir):
        print(f"Warning: 'run' directory not found in repo.")
        return items

    for sh_file in glob.glob(os.path.join(run_dir, "*.sh")):
        script_name = os.path.splitext(os.path.basename(sh_file))[0]
        display_name = script_name  # V√Ωchoz√≠ jm√©no
        icon = "system-run"  # V√Ωchoz√≠ ikona
        try:
            with open(sh_file, "r", encoding="utf-8") as f:
                lines = f.readlines()

            # Hled√° '#name:' na druh√©m ≈ô√°dku (index 1)
            if len(lines) > 1 and lines[1].strip().startswith("#name:"):
                display_name = lines[1].split(":", 1)[1].strip()

            # Hled√° '#icon:' na t≈ôet√≠m ≈ô√°dku (index 2)
            if len(lines) > 2 and lines[2].strip().startswith("#icon:"):
                icon = lines[2].split(":", 1)[1].strip()

            items.append(
                {
                    "label": display_name,
                    "icon": icon,
                    "command": ["spacefin-cli", "run", script_name],
                }
            )
        except Exception as e:
            print(f"Error parsing {sh_file}: {e}")
    return items


# Funkce pro otev≈ôen√≠ p≈ô√≠kazov√©ho termin√°lu
def run_command_in_gui(command):
# ... (k√≥d pro run_command_in_gui z≈Øst√°v√° stejn√Ω) ...
# ... (existing code) ...
    import shutil
    import subprocess

    # Find a terminal emulator
# ... (existing code) ...
        # TODO: Show a GTK error dialog
        return

    # Vytvo≈ô kompletn√≠ p≈ô√≠kaz pro otev≈ôen√≠ termin√°lu a spu≈°tƒõn√≠ p≈ô√≠kazu
# ... (existing code) ...
    bash_cmd = " ".join(command) + "; echo '\nPress Enter to exit'; read"

    if terminal_emulator in ["ghostty", "konsole"]:
# ... (existing code) ...
    elif terminal_emulator == "mate-terminal":
        full_command = [
            terminal_emulator,
# ... (existing code) ...
            f"'{bash_cmd}'",
        ]
    else:
        # Default for gnome-terminal, xterm, etc.
# ... (existing code) ...
        full_command = [terminal_emulator, "--", "bash", "-c", bash_cmd]

    # Spus≈• termin√°l s p≈ô√≠kazem
    subprocess.Popen(full_command)


class LinuxConfigurator(Gtk.Window):
    def __init__(self):
        Gtk.Window.__init__(self, title="Spacefin-Welcome!")
        self.set_default_size(800, 570)
        self.set_border_width(10)

        # Vytvo≈ôen√≠ doƒçasn√©ho adres√°≈ôe
        self.temp_dir = tempfile.TemporaryDirectory()
        print(f"Cloning repo into {self.temp_dir.name}...")

        try:
            # Klonov√°n√≠ repozit√°≈ôe
            clone_path = clone_repo(DEFAULT_REPO_URL, self.temp_dir.name)
            # Naƒçten√≠ dynamick√Ωch polo≈æek
            self.install_items = load_install_items(clone_path)
            self.run_items = load_run_items(clone_path)
            print(
                f"Found {len(self.install_items)} install items and {len(self.run_items)} run items."
            )
        except Exception as e:
            print(f"FATAL: Could not clone or parse repo: {e}")
            # TODO: Zobrazit GTK chybov√Ω dialog u≈æivateli
            self.install_items = []
            self.run_items = []

        self.main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        self.add(self.main_box)
# ... (existing code) ...
        self.header = Gtk.Label()

        # Funkce pro z√≠sk√°n√≠ jm√©na distribuce
        def get_distro_name():
# ... (existing code) ...
                    for line in f:
                        if line.startswith("PRETTY_NAME="):
                            distro_name = line.split("=", 1)[1].strip().strip('"')
# ... (existing code) ...
            except Exception as e:
                print(f"Chyba p≈ôi naƒç√≠t√°n√≠ distribuce: {e}")
            return distro_name
# ... (existing code) ...
        # Z√≠sk√°n√≠ u≈æivatelsk√©ho jm√©na
        user_name = getpass.getuser()

        # Pou≈æit√≠ v Gtk headeru
# ... (existing code) ...
        distro_name = get_distro_name()
        self.header.set_markup(
            f"<span size='xx-large' weight='bold'>Welcome, {user_name}!</span>\n<span size='large'>To your {distro_name}.</span>"
# ... (existing code) ...
        self.header.set_justify(Gtk.Justification.CENTER)
        self.main_box.pack_start(self.header, False, False, 10)

        self.create_main_page()

    def create_main_page(self):
# ... (k√≥d pro create_main_page z≈Øst√°v√° stejn√Ω) ...
# ... (existing code) ...
        if hasattr(self, "content_box"):
            self.main_box.remove(self.content_box)  # Odstranƒõn√≠ star√© str√°nky

        self.content_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
# ... (existing code) ...
        self.main_box.pack_start(self.content_box, True, True, 10)

        def get_distro_logo_name():
            logo_name = "default"  # V√Ωchoz√≠ hodnota
# ... (existing code) ...
                        if line.startswith("LOGO="):
                            logo_name = line.strip().split("=")[1].strip('"')
                            break
            return logo_name.lower()
# ... (existing code) ...
        distro_logo = get_distro_logo_name()
        print(f"N√°zev loga distribuce: {distro_logo}")

        def find_distro_logo():
# ... (existing code) ...
            logo_name = get_distro_logo_name()
            possible_paths = [
                f"/usr/share/icons/hicolor/256x256/apps/{logo_name}.png",
# ... (existing code) ...
                f"/usr/share/pixmaps/{logo_name}.svg",
            ]

            for path in possible_paths:
# ... (existing code) ...
                if os.path.exists(path):
                    return path  # Pokud logo existuje, vr√°t√≠me cestu

            return "/usr/share/icons/better-welcome.png"  # Z√°lo≈æn√≠ logo
# ... (existing code) ...
        distro_logo_path = find_distro_logo()
        print(f"Cesta k logu: {distro_logo_path}")

        def get_distro_image():
# ... (existing code) ...
            """Vytvo≈ô√≠ GTK Image s logem distribuce"""
            logo_path = find_distro_logo()
            print(f"Pou≈æit√© logo: {logo_path}")  # Debug v√Ωpis
# ... (existing code) ...
            try:
                if logo_path.endswith(".svg"):
                    # SVG se naƒç√≠t√° trochu jinak
# ... (existing code) ...
                    pixbuf = GdkPixbuf.Pixbuf.new_from_file_at_size(logo_path, 64, 64)
                    image = Gtk.Image.new_from_pixbuf(pixbuf)
                else:
# ... (existing code) ...
                    # PNG/JPG se naƒç√≠taj√≠ p≈ô√≠mo
                    image = Gtk.Image.new_from_file(logo_path)
            except Exception as e:
# ... (existing code) ...
                print(f"Chyba naƒçten√≠ loga: {e}")
                image = Gtk.Image.new_from_file(
                    "/usr/share/icons/better-welcome.png"
# ... (existing code) ...
                )  # V√Ωchoz√≠ logo

            return image

        image = get_distro_image()
# ... (existing code) ...
        self.content_box.pack_start(image, False, False, 10)  # P≈ôid√°n√≠ obr√°zku

        # Main control buttons
        grid = Gtk.Grid()
# ... (existing code) ...
        grid.set_column_spacing(10)
        grid.set_row_spacing(10)

        # Obalen√≠ gridu do centr√°ln√≠ho boxu
# ... (existing code) ...
        grid_alignment = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        grid_alignment.set_valign(Gtk.Align.CENTER)  # Vertik√°ln√≠ centrov√°n√≠
        grid_alignment.set_halign(Gtk.Align.CENTER)  # Horizont√°ln√≠ centrov√°n√≠
# ... (existing code) ...
        grid_alignment.pack_start(grid, False, False, 0)

        self.content_box.pack_start(grid_alignment, True, True, 10)

        buttons = [
# ... (existing code) ...
            ("Show System Info", self.on_system_info_clicked),
            ("System Update", self.on_update_clicked),
            ("Disk Usage", self.on_disk_usage_clicked),
# ... (existing code) ...
            ("Tweaks", self.on_tweaks_clicked),
            ("Repairs", self.on_repairs_clicked),
            ("Exit", self.on_exit_clicked),
# ... (existing code) ...
        ]

        for i, (label, callback) in enumerate(buttons):
            button = Gtk.Button(label=label)
# ... (existing code) ...
            button.connect("clicked", callback)
            button.set_size_request(180, 50)
            grid.attach(button, i % 3, i // 3, 1, 1)

        self.show_all()

    def create_tweaks_page(self):
        self.main_box.remove(self.content_box)

        self.content_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        self.main_box.pack_start(self.content_box, True, True, 10)

        grid = Gtk.Grid()
        grid.set_column_spacing(10)
        grid.set_row_spacing(10)

        # Obalen√≠ gridu do centr√°ln√≠ho boxu
        grid_alignment = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        grid_alignment.set_valign(Gtk.Align.CENTER)  # Vertik√°ln√≠ centrov√°n√≠
        grid_alignment.set_halign(Gtk.Align.CENTER)  # Horizont√°ln√≠ centrov√°n√≠
        grid_alignment.pack_start(grid, False, False, 0)

        self.content_box.pack_start(grid_alignment, True, True, 10)

        # P≈ôid√°n√≠ textov√©ho popisku nad seznam
        instruction_label = Gtk.Label(label="Choose what to install")
        instruction_label.set_markup(
            "<span size='medium' weight='bold'>Choose what to install (uses 'spacefin-cli install')</span>"
        )
        instruction_label.set_justify(Gtk.Justification.CENTER)
        self.content_box.pack_start(instruction_label, False, False, 10)

        # Vytvo≈ôen√≠ ListBoxu
        listbox = Gtk.ListBox()
        listbox.set_selection_mode(Gtk.SelectionMode.SINGLE)
        listbox.set_sort_func(lambda row1, row2: 0)

        # === Dynamick√© naƒçten√≠ polo≈æek ===
        items = self.install_items
        # ================================

        # Vytvo≈ôen√≠ ≈ô√°dk≈Ø (polo≈æek) v seznamu
        for item in items:
            row = Gtk.ListBoxRow()
            hbox = Gtk.Box(
                orientation=Gtk.Orientation.HORIZONTAL,
                spacing=15,
                margin_top=10,
                margin_bottom=10,
            )
            row.add(hbox)

            # Vytvo≈ôen√≠ ikony
            icon = Gtk.Image.new_from_icon_name(
                item["icon"], Gtk.IconSize.LARGE_TOOLBAR
            )
            icon.set_halign(Gtk.Align.CENTER)
            icon.set_valign(Gtk.Align.CENTER)

            # Vytvo≈ôen√≠ textov√©ho labelu
            label = Gtk.Label(label=item["label"])
            label.set_xalign(0)

            # P≈ôid√°n√≠ ikony a textu do boxu
            hbox.pack_start(icon, False, False, 0)
            hbox.pack_start(label, True, True, 0)

            # Ulo≈æen√≠ ≈ô√°dku do seznamu
            listbox.add(row)

        self.items = items

        # Vytvo≈ôen√≠ skrolovac√≠ho okna pro ListBox
        scrolled_window = Gtk.ScrolledWindow()
        scrolled_window.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.ALWAYS)
        scrolled_window.add(listbox)
        scrolled_window.set_size_request(400, 250)

        # P≈ôid√°n√≠ skrolovac√≠ho okna do content_box
        self.content_box.pack_start(scrolled_window, True, True, 10)

        # Button box
        button_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
        self.content_box.pack_start(button_box, False, False, 10)

        back_button = Gtk.Button(label="Back")
        back_button.connect("clicked", lambda _: self.create_main_page())
        back_button.set_size_request(350, 20)  # Nastaven√≠ velikosti
        button_box.pack_start(back_button, False, False, 10)

        # Tlaƒç√≠tko Vybrat
        select_button = Gtk.Button(label="Select")
        select_button.connect("clicked", self.on_select_button_clicked, listbox, items)
        select_button.set_size_request(350, 20)
        button_box.pack_start(select_button, False, False, 10)

        # Nastaven√≠, aby tlaƒç√≠tka byla vedle sebe
        self.show_all()

    def create_repairs_page(self):
        """Kompletnƒõ p≈ôepracovan√° str√°nka, nyn√≠ dynamicky naƒç√≠t√° 'run' skripty."""
        self.main_box.remove(self.content_box)

        self.content_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        self.main_box.pack_start(self.content_box, True, True, 10)

        grid = Gtk.Grid()
        grid.set_column_spacing(10)
        grid.set_row_spacing(10)

        # Obalen√≠ gridu do centr√°ln√≠ho boxu
        grid_alignment = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        grid_alignment.set_valign(Gtk.Align.CENTER)  # Vertik√°ln√≠ centrov√°n√≠
        grid_alignment.set_halign(Gtk.Align.CENTER)  # Horizont√°ln√≠ centrov√°n√≠
        grid_alignment.pack_start(grid, False, False, 0)

        self.content_box.pack_start(grid_alignment, True, True, 10)

        # P≈ôid√°n√≠ textov√©ho popisku nad seznam
        instruction_label = Gtk.Label(label="Choose what to run")
        instruction_label.set_markup(
            "<span size='medium' weight='bold'>Choose what to run (uses 'spacefin-cli run')</span>"
        )
        instruction_label.set_justify(Gtk.Justification.CENTER)
        self.content_box.pack_start(instruction_label, False, False, 10)

        # Vytvo≈ôen√≠ ListBoxu
        listbox = Gtk.ListBox()
        listbox.set_selection_mode(Gtk.SelectionMode.SINGLE)
        listbox.set_sort_func(lambda row1, row2: 0)

        # === Dynamick√© naƒçten√≠ polo≈æek ===
        items = self.run_items
        # ================================

        # Vytvo≈ôen√≠ ≈ô√°dk≈Ø (polo≈æek) v seznamu
        for item in items:
            row = Gtk.ListBoxRow()
            hbox = Gtk.Box(
                orientation=Gtk.Orientation.HORIZONTAL,
                spacing=15,
                margin_top=10,
                margin_bottom=10,
            )
            row.add(hbox)

            # Vytvo≈ôen√≠ ikony
            icon = Gtk.Image.new_from_icon_name(
                item["icon"], Gtk.IconSize.LARGE_TOOLBAR
            )
            icon.set_halign(Gtk.Align.CENTER)
            icon.set_valign(Gtk.Align.CENTER)

            # Vytvo≈ôen√≠ textov√©ho labelu
            label = Gtk.Label(label=item["label"])
            label.set_xalign(0)

            # P≈ôid√°n√≠ ikony a textu do boxu
            hbox.pack_start(icon, False, False, 0)
            hbox.pack_start(label, True, True, 0)

            # Ulo≈æen√≠ ≈ô√°dku do seznamu
            listbox.add(row)

        self.items = items

        # Vytvo≈ôen√≠ skrolovac√≠ho okna pro ListBox
        scrolled_window = Gtk.ScrolledWindow()
        scrolled_window.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.ALWAYS)
        scrolled_window.add(listbox)
        scrolled_window.set_size_request(400, 250)

        # P≈ôid√°n√≠ skrolovac√≠ho okna do content_box
        self.content_box.pack_start(scrolled_window, True, True, 10)

        # Button box
        button_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
        self.content_box.pack_start(button_box, False, False, 10)

        back_button = Gtk.Button(label="Back")
        back_button.connect("clicked", lambda _: self.create_main_page())
        back_button.set_size_request(350, 20)  # Nastaven√≠ velikosti
        button_box.pack_start(back_button, False, False, 10)

        # Tlaƒç√≠tko Vybrat
        select_button = Gtk.Button(label="Select")
        select_button.connect("clicked", self.on_select_button_clicked, listbox, items)
        select_button.set_size_request(350, 20)
        button_box.pack_start(select_button, False, False, 10)

        # Nastaven√≠, aby tlaƒç√≠tka byla vedle sebe
        self.show_all()

    def on_select_button_clicked(self, widget, listbox, items):
        """Obecn√° funkce pro spu≈°tƒõn√≠ vybran√© polo≈æky (z Tweaks nebo Repairs)."""
        selected_row = listbox.get_selected_row()
        if selected_row:
            index = selected_row.get_index()
            selected_item = items[index]
            run_command_in_gui(selected_item["command"])

    def list_clicked(self, widget):
        print("List clicked")

    def on_tweaks_clicked(self, widget):
        self.create_tweaks_page()

    def on_repairs_clicked(self, widget):
        self.create_repairs_page()

    # --- Main Page Callbacks (z≈Øst√°vaj√≠) ---
    def on_system_info_clicked(self, widget):
        run_command_in_gui(["spacefin-cli", "run", "system-info"])

    def on_update_clicked(self, widget):
        run_command_in_gui(["spacefin-cli", "run", "update"])

    def on_disk_usage_clicked(self, widget):
        run_command_in_gui(["spacefin-cli", "run", "disk-usage"])

    def on_exit_clicked(self, widget):
        Gtk.main_quit()

    # --- Ostatn√≠ 'on_..._clicked' metody jsou nyn√≠ zastaral√© a odstranƒõn√© ---
    # --- (on_mirrors_clicked, on_refind_clicked, atd.) ---
    # --- (create_package_repairs_page, on_package_repairs_clicked, atd.) ---


def main():
    parser = setup_argparse()
    args = parser.parse_args()

    if args.version:
        print(
            f"{colors.BCyan}üö™ spacefin-welcome version 2.1-dynamic (part of spacefin-cli){colors.NC}"
        )
        sys.exit(0)

    if args.command == "gui":
        window = LinuxConfigurator()
        window.connect("destroy", Gtk.main_quit)
        # P≈ôid√°n√≠ √∫klidu doƒçasn√©ho adres√°≈ôe p≈ôi zav≈ôen√≠ okna
        window.connect("destroy", lambda w: window.temp_dir.cleanup())
        window.show_all()
        Gtk.main()
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
